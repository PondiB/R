This R script will enable you calculate bush density using count data and ndvi+crown cover data as covariates.

First we set up some options (you do not have to do this):

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(fig.path = 'figure/rfr-')
```

To make our results reproducable, let's set a random seed.

```{r test-a, cache=FALSE}
set.seed(500)
```

Let's list down the packages to be used in this session. Packages will be installed if not already installed.
They will then be loaded into the session

```{r test-a, cache=FALSE}
.packages = c("sp","rgdal","raster","randomForest","plyr","xlsx","xlsxjars","dplyr","caret","car")
.inst <- .packages %in% installed.packages()
if(length(.packages[!.inst]) > 0) install.packages(.packages[!.inst])
lapply(.packages, require, character.only=TRUE)
```

Set working directory
```{r test-a, cache=FALSE}
setwd("C:/Users/jymutua/WorkDocs/Bush_Density_Mapping")
```

Read in data from excel sheet
```{r test-a, cache=FALSE}
BushData <- read.xlsx("Field_data/Bush_Density_Sampling_Points.xlsx", sheetName = "BushDensity", header=TRUE)
```

Calculate values by finding the median in crown cover and mean of values for counts
Note that 1 plot = 0.01 ha; 4 plots = 0.04 ha
```{r test-a, cache=FALSE}
BushData$shrubs_less_1.5 <- apply(BushData[,8:11], 1, sum, na.rm=TRUE)
BushData$shrubs_more_1.5_no_stem <- apply(BushData[,16:19], 1, sum, na.rm=TRUE)
BushData$shrubs_more_1.5_stem <- apply(BushData[,24:27], 1, sum, na.rm=TRUE)
```

Create new data frame with the columns you need
```{r test-a, cache=FALSE}
BushData_clean<-BushData[,c("Waypoint_No","Latitude","Longitude",
                            "shrubs_less_1.5","shrubs_more_1.5_no_stem","shrubs_more_1.5_stem")]
```

Add two new columns of shrubs more than 1.5 and all shrubs in general
```{r test-a, cache=FALSE}
BushData_clean$shrubs_more_1.5 <- apply(BushData_clean[,5:6], 1, sum, na.rm=TRUE)
BushData_clean$shrubs_all <- apply(BushData_clean[,4:6], 1, sum, na.rm=TRUE)
```

Round columns
```{r test-a, cache=FALSE}
BushData_clean<-BushData_clean %>% mutate_each(funs(round(.,0)), shrubs_less_1.5, 
                                               shrubs_more_1.5_no_stem, shrubs_more_1.5_stem, 
                                               shrubs_more_1.5, shrubs_all)
```

Remove all NAs
```{r test-a, cache=FALSE}
BushData_clean<-BushData_clean[complete.cases(BushData_clean),]
```

Export data to .csv
```{r test-a, cache=FALSE}
write.csv(BushData_clean, file = "Otjozondjupa_BushData_trainData.csv",row.names=FALSE)
```

Get long and lat from your data.frame. Make sure that the order is in lon/lat.
Convert the dataraframe into a spatial point dataframe
```{r test-a, cache=FALSE}
xy <- BushData_clean[,c(3,2)]
trainDatageo <- SpatialPointsDataFrame(coords = xy, data = BushData_clean,
                                    proj4string = CRS("+proj=longlat +datum=WGS84"))
trainData <- spTransform(trainDatageo, CRS('+proj=utm +zone=33 +south +datum=WGS84'))
```

Let's do some background checking of the field names
```{r test-a, cache=FALSE}
names(trainData)
```
rename trainData fields
```{r test-a, cache=FALSE}
names(trainData) <- c("Waypoint_No","Latitude","Longitude","shrubs_less_1.5",
                      "shrubs_more_1.5_no_stem", "shrubs_more_1.5_stem", "shrubs_more_1.5", "shrubs_all")
```

Import the rest of input data
```{r test-a, cache=FALSE}
rasList <- list.files("Raster_data/", pattern = ".tif$", full.names = TRUE)
```

Create a raster stack and rename the contents
```{r test-a, cache=FALSE}
rstack <- stack(rasList)
names(rstack) <- c("crown_cover","NDVI","band2","band3","band4","band5","band6","band7")
```

Note that we are only calculating bush density in the bush area LULC catageory
Import teh bush area mask
```{r test-a, cache=FALSE}
Otjo_BushArea <- raster("C:/Users/jymutua/WorkDocs/Bush_Density_Mapping/Raster_data/Other_data/Otjozondjupa_BushArea_2016.tif")
```

Let's check various stuff
```{r test-a, cache=FALSE}
crs(rstack)
crs(Otjo_BushArea)
crs(trainData)
extent(rstack)
extent(Otjo_BushArea)
extent(trainData)
```

Set extent of the training data to match covs
```{r test-a, cache=FALSE}
trainData@bbox <- bbox(Otjo_BushArea)
```
Mask, read and stack the covariates
```{r test-a, cache=FALSE}
covs <- mask(rstack, Otjo_BushArea)
writeRaster(covs, filename = "Otjozondjupa_Stack_2016.tif", format = "GTiff", overwrite = TRUE)
```

Assign raster values to the training data
```{r test-a, cache=FALSE}
v<-as.data.frame(extract(covs,trainData))
trainData@data=data.frame(trainData@data, v[match(rownames(trainData@data),rownames(v)),])
```

Rename fields in training dataset, remove NAs and write the dataset as a .csv
```{r test-a, cache=FALSE}
names(trainData) <- c("waypoint_no","latitude","longitude","shrubs_less1.5",
                      "shrubs_more1.5_no_stem","shrubs_more1.5_stem","shrubs_more1.5", "shrubs_all",
                      "crown_cover","NDVI","band2","band3","band4","band5","band6","band7")
trainData@data<-trainData@data[complete.cases(trainData@data),]
write.csv(trainData@data, file = "Otjozondjupa_MF_trainData.csv",row.names=FALSE)
````

Randomly select index numbers and use that for splitting the data
Set 75% as training nad 25% as test data
```{r test-a, cache=FALSE}
trainIndex=sample(1:nrow(trainData@data),size=0.75*nrow(trainData@data))
trainingSet=trainData@data[trainIndex,]
testingSet=trainData@data[-trainIndex,]
```

Let's plot  some of the variables
```{r test-a, cache=FALSE}
scatterplot(NDVI ~ shrubs_less1.5+crown_cover, data=trainingSet, 
            xlab="Count of Shrubs less than 1.5m",ylab="NDVI", main="NDVI versus Count of Shrubs (less than 1.5m)")
scatterplot(NDVI ~ shrubs_more1.5, data=trainingSet, 
            xlab="Count of shrub (more than 1.5m)",ylab="NDVI", main="NDVI versus Count of shrub (more than 1.5m)")
scatterplot(shrubs_more1.5 ~ crown_cover, data=trainingSet, 
            xlab="Crown cover",ylab="shrubs_more1.5", main="shrubs_more1.5 versus Crown cover")
scatterplot(shrubs_less1.5 ~ crown_cover, data=trainingSet, 
            xlab="Crown cover",ylab="shrubs_less1.5", main="shrubs_less1.5 versus Crown cover")
```

You can now set up the model using randomly sampled data
```{r test-a, cache=FALSE}
accuracies1<-c()
accuracies2<-c()
accuracies3<-c()
```
Construct the rf model for shrubs less than 1.5m
```{r test-a, cache=FALSE}
model1 <- randomForest(x=trainingSet[,c(9:10)],
                       y=trainingSet[,"shrubs_less1.5"], 
                       ntree=2000, proximity=TRUE, importance=TRUE)
```

Predict bush density for shrubs less than 1.5m
```{r test-a, cache=FALSE}
predict(covs, model1, filename="otjo_bd1", format='GTiff', type="response", 
        index=1, na.rm=TRUE, progress="window", overwrite=TRUE)
prediction1 <- predict(model1, testingSet)
testingSet$rightPred1 <- prediction1 == testingSet$shrubs_less1.5
t1<-table(prediction1, testingSet$shrubs_less1.5)
print(t1)
accuracy1 <- sum(testingSet$rightPred1)/nrow(testingSet)
accuracies1 <- c(accuracies1,accuracy1)
print(accuracy1)
```

Construct the rf model for shrubs more than 1.5m
```{r test-a, cache=FALSE}
model2 <- randomForest(x=trainingSet[,c(9:10)],
                       y=trainingSet[,"shrubs_more1.5"], 
                       ntree=2000, proximity=TRUE, importance=TRUE)
```

Predict bush density for shrubs more than 1.5m
```{r test-a, cache=FALSE}
predict(covs, model2, filename="otjo_bd2", format='GTiff', type="response", 
        index=1, na.rm=TRUE, progress="window", overwrite=TRUE)
prediction2 <- predict(model2, testingSet)
testingSet$rightPred2 <- prediction2 == testingSet$shrubs_more1.5
t2<-table(prediction2, testingSet$shrubs_more1.5)
print(t2)
accuracy2 <- sum(testingSet$rightPred2)/nrow(testingSet)
accuracies2 <- c(accuracies2,accuracy2)
print(accuracy2)
```

Plot mean decrease in variable importance
```{r test-a, cache=FALSE}
varImpPlot(model2, type=1)
varImpPlot(model3, type=1)
```

Construct the rf model for for all shrubs
```{r test-a, cache=FALSE}
model3 <- randomForest(x=trainingSet[,c(9:10)],
                       y=trainingSet[,"shrubs_all"], 
                       ntree=2000, proximity=TRUE, importance=TRUE)
```

Predict bush density for all shrubs
```{r test-a, cache=FALSE}
predict(covs, model3, filename="otjo_bd3", format='GTiff', type="response", 
        index=1, na.rm=TRUE, progress="window", overwrite=TRUE)
prediction3 <- predict(model3, testingSet)
testingSet$rightPred3 <- prediction3 == testingSet$shrubs_all
t3<-table(prediction3, testingSet$shrubs_all)
print(t3)
accuracy3 <- sum(testingSet$rightPred3)/nrow(testingSet)
accuracies3 <- c(accuracies3,accuracy3)
print(accuracy3)
```

Plot mean decrease in variable importance
```{r test-a, cache=FALSE}
varImpPlot(model1, type=1)
varImpPlot(model2, type=1)
varImpPlot(model3, type=1)
```
