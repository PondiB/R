### Introduction
This scripts constructs a time series using MODIS data from the Global 
Agriculture Monitoring (GLAM) Project 
"(http://pekko.geog.umd.edu/usda/beta/data_new.php)"
Author: John Mutua, Email address: j.y.mutua@cgiar.org

### Start of script
First, clear your work space
```{r}
rm(list = ls(all = TRUE))
```

### Preliminaries
You need to first install all the required packages. Type (within R) install.
packages("name of package") (This needs to be done just once.)
You then load the packages using the 'library' function:

```{r}
library(raster) #working with rasters
library(rgdal) #working with geospatial data
library(ggplot2) #creating graphs
library(dplyr) #subsetting by season
library(lubridate) #working with dates
library(grid) #arranging plots
library(gridExtra) #arranging plots
```

This needs to be done every time you start R. (There is a way to have the 
package loaded automatically every time, but we won't discuss that here.)

To get help on the functions and data sets in R, use `help()` or `?`. 
For example, to view the help file for the `calc` function, type one of 
the following:

```{r help, eval=FALSE}
help(calc)
?calc
```

Set your working directory as follows:
```{r}
setwd("D:/ToBackup/Data/Regional/LDN_Namibia")
```

Import all NDVI raster datasets in your working directory and create a raster 
stack
```{r}
rasList <- list.files("NDVI_Modis/AOI_NDVI", full.names = TRUE, pattern = ".tif$")
NDVI_Otjo_stack <- stack(rasList) 
```

Insert a Temporal id to the data frame. Characters corresponding to the year are located between the 20 and 23 position
while characters corresponding to the date are located between the 24 and 26 position
```{r}
oldnames<-names(NDVI_Otjo_stack)
head(oldnames)
year<-substr(oldnames,20,23)
table(year)
julianDay<-substr(oldnames,24,26)
```

Calculate mean NDVI for each raster and convert output array to a data frame
```{r}
avg_NDVI_Otjo <- as.data.frame(cellStats(NDVI_Otjo_stack,mean))
```

Rename the NDVI column
```{r}
names(avg_NDVI_Otjo) <- "meanNDVI"
```

Add julianDay values as a column in the data frame
```{r}
avg_NDVI_Otjo$julianDay <- julianDay
```

Check out the class in the new column
```{r}
class(avg_NDVI_Otjo$julianDay)
```

Create a time vector and convert it to a date
```{r}
tVector<-paste(year,julianDay,sep="-")
timeNDVI<-as.Date(tVector,format = "%Y-%j")
```

Add date values as a column in the data frame
```{r}
avg_NDVI_Otjo$date <- timeNDVI
```

Check out classes of the two columns now
```{r}
class(avg_NDVI_Otjo$date)
class(avg_NDVI_Otjo$julianDay)
```

Add site and year columns to the data frame
```{r}
avg_NDVI_Otjo$site <- "Otjozondjupa Region"
avg_NDVI_Otjo$year <- year
```

### Plot time series

Plot NDVI by year although this doesn't make sense

```{r}
ggplot(avg_NDVI_Otjo, aes(year, meanNDVI), na.rm=TRUE) +
  geom_point(size=4,colour = "PeachPuff4") + 
  ggtitle("MODIS Derived NDVI - Otjozondjupa Region") +
  xlab("Time") + ylab("Mean NDVI") +
  theme(text = element_text(size=20))
```

Write NDVI data to a comma separated file in your local drive
```{r}
Otjo_NDVI_Values<-avg_NDVI_Otjo
```

Drop the row.names column
```{r}
row.names(Otjo_NDVI_Values)<-NULL
write.csv(Otjo_NDVI_Values, file="meanNDVI_Otjo_2005-2015.csv", overwrite=TRUE)
```

Add month to data frame
```{r}
avg_NDVI_Otjo$month  <- month(avg_NDVI_Otjo$date)
```

Subset data by season by creating a new categorical variable called season by grouping months together
```{r}
avg_NDVI_Otjo_Seasons <- avg_NDVI_Otjo %>% 
  mutate(season = 
           ifelse(month %in% c(12, 1, 2, 3, 4, 5), "Hot-Wet",
                  ifelse(month %in% c(6, 7, 8), "Cool-Dry",
                         ifelse(month %in% c(9, 10, 11), "Hot-Dry", "Error"))))
```

Let's check to see if that worked
```{r}
head(avg_NDVI_Otjo_Seasons$month)
head(avg_NDVI_Otjo_Seasons$season)
tail(avg_NDVI_Otjo_Seasons$month)
tail(avg_NDVI_Otjo_Seasons$season)
```

### Start of monthly plots

Aggregate data by month
```{r}
monthNDVI<-avg_NDVI_Otjo_Seasons %>%
  group_by(month) %>%
  summarise(monthNDVI=mean(meanNDVI, na.rm=TRUE))
```

Convert month numeric to month abbreviation
```{r}
monthNDVI$month_name <- month.abb[monthNDVI$month]
```

Reassign the "month_name"" field to a factor
```{r}
monthNDVI$month_name = factor(monthNDVI$month_name,
                              levels=c('Jan','Feb','Mar',
                                       'Apr','May','Jun','Jul',
                                       'Aug','Sep','Oct',
                                       'Nov','Dec'))
```

Plot data by month
```{r}
Monthly_NDVI_Plot<-ggplot(monthNDVI, aes(month_name, monthNDVI, group=4)) +
  geom_line(colour="red") +
  ggtitle("Average NDVI (2005-2015) - Monthly") +
  xlab("Month") + ylab("Mean NDVI") +
  theme(plot.title = element_text(lineheight=.8, face="bold",
                                  size = 20)) +
  theme(text = element_text(size=18)) + geom_point()
Monthly_NDVI_Plot
```

Plot the same plot as before but with one plot per season, save as .pdf
```{r}
ggsave(file="Otjozondjupa_Monthly_NDVI.pdf", width = 297, height = 210, units = "mm")
```

### Start of indivindual seasonal plots
Plot HOT-WET Season
```{r}
Hot_Wet <- subset(monthNDVI, month >= 12 | month <= 5)
target <- c("12", "5", "4", "3", "2", "1")
Hot_Wet<-Hot_Wet[match(target, Hot_Wet$month),]
Hot_Wet$month_name <- factor(Hot_Wet$month_name, c("Dec", "Jan", "Feb", "Mar", "Apr", "May"))
Hot_Wet_NDVI_Plot<-ggplot(Hot_Wet, aes(month_name, monthNDVI, group=1)) +
  geom_line(colour="red") +
  ggtitle("Average NDVI (2005-2015) - Hot Wet Season ") +
  xlab("Month") + ylab("Mean NDVI") +
  theme(plot.title = element_text(lineheight=.8, face="bold",
                                  size = 20)) +
  theme(text = element_text(size=18)) + geom_point()
Hot_Wet_NDVI_Plot
```

Plot the same plot as before but with one plot per season, save as .pdf
```{r}
ggsave(file="Otjozondjupa_Hot_Wet_NDVI.pdf", width = 297, height = 210, units = "mm")
```

Plot COOL-DRY Season
```{r}
Cool_Dry <- subset(monthNDVI, month <= 8 & month >= 6)
Cool_Dry_NDVI_Plot<-ggplot(Cool_Dry, aes(month_name, monthNDVI, group=1)) +
  geom_line(colour="red") +
  ggtitle("Average NDVI (2005-2015) - Cool Dry Season") +
  xlab("Month") + ylab("Mean NDVI") +
  theme(plot.title = element_text(lineheight=.8, face="bold",
                                  size = 20)) +
  theme(text = element_text(size=18)) + geom_point()
Cool_Dry_NDVI_Plot
```

Plot the same plot as before but with one plot per season, save as .pdf
```{r}
ggsave(file="Otjozondjupa_Cool_Dry_NDVI.pdf", width = 297, height = 210, units = "mm")
```

Plot HOT DRY Season
```{r}
Hot_Dry <- subset(monthNDVI, month <= 11 & month >= 9)
Hot_Dry_NDVI_Plot<-ggplot(Hot_Dry, aes(month_name, monthNDVI, group=1)) +
  geom_line(colour="red") +
  ggtitle("Average NDVI (2005-2015) - Hot Dry Season") +
  xlab("Month") + ylab("Mean NDVI") +
  theme(plot.title = element_text(lineheight=.8, face="bold",
                                  size = 20)) +
  theme(text = element_text(size=18)) + geom_point()
Hot_Dry_NDVI_Plot
```

Plot the same plot as before but with one plot per season, save as .pdf
```{r}
ggsave(file="Otjozondjupa_Hot_Dry_NDVI.pdf", width = 297, height = 210, units = "mm")
```

### Start of merged seasonal plots
Let's aggregate data by season
```{r}
seasonNDVI<-avg_NDVI_Otjo_Seasons %>%
  group_by(year, season) %>%
  summarise(seasonNDVI=mean(meanNDVI, na.rm=TRUE))
```

Export comma separated file of seasonal NDVI values
```{r}
write.csv(seasonNDVI, file="Seasonal_NDVI_2005-2015.csv")
```

Plot data by season
```{r}
Seasonal_NDVI_Plot<-ggplot(seasonNDVI, aes(year, seasonNDVI, group=3)) +
  geom_line(colour="red") +
  ggtitle("Average NDVI (2005-2015) - Seasonal") +
  xlab("Year") + ylab("Mean NDVI") +
  theme(plot.title = element_text(lineheight=.8, face="bold",
                                  size = 20)) +
  theme(text = element_text(size=18)) + geom_point()
```

Plot the same plot as before but with one plot per season, save as .pdf
```{r}
Seasonal_NDVI_Plot + facet_grid(. ~ season)
ggsave(file="Otjozondjupa_Seasonal_NDVI.pdf", width = 297, height = 210, units = "mm")
```

Plot the same plot in a landscape orientation, save as .pdf
```{r}
Seasonal_NDVI_Plot + facet_grid(season ~ .)
ggsave(file="Otjozondjupa_Seasonal_NDVI.pdf", width = 297, height = 210, units = "mm")
```
